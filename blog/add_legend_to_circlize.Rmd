Add legends to circlize plot
=============================


```{r, echo = FALSE, warning = FALSE, results = "hide", message = FALSE, include = FALSE}
suppressPackageStartupMessages(library(ComplexHeatmap))
suppressPackageStartupMessages(library(gridBase))
suppressPackageStartupMessages(library(circlize))
```

**circlize** package provides complete freedom for users to design their own graphics by
implementing the self-defined function `panel.fun`. However one drawback arises that **circlize**
is completely blind to users' data so that one important thing is missing for the visualization 
which is the legend.

Although legends cannot be automatically generated by **circlize** package, by using functionality from
other R packages, it is just a few more work to really implement it. 
In this post, I will demonstrate how to customize legends and arrange to the circular plot.

As an example, I generated a circular plot which contains two tracks and links inside the circle. The first
track will have a legend that contains points, the second track will have a legend that contains lines,
and the links correspond to a continuous color mapping. The code is wrapped into a function 
so that it can be used repeatedly.

```{r}
library(circlize)

set.seed(123)
col_fun = colorRamp2(c(-1, 0, 1), c("green", "yellow", "red"))
circlize_plot = function() {
	circos.initializeWithIdeogram(plotType = NULL)

	bed = generateRandomBed(nr = 300)
	bed = generateRandomBed(nr = 300, nc = 2)
	circos.genomicTrackPlotRegion(bed,
		panel.fun = function(region, value, ...) {
			circos.genomicPoints(region, value, cex = 0.5, pch = 16, col = 2:3, ...)
	})

	bed = generateRandomBed(nr = 500, nc = 2)
	circos.genomicTrackPlotRegion(bed,
		panel.fun = function(region, value, ...) {
			circos.genomicLines(region, value, col = 4:5, ...)
	})

	bed1 = generateRandomBed(nr = 100)
	bed1 = bed1[sample(nrow(bed1), 20), ]
	bed2 = generateRandomBed(nr = 100)
	bed2 = bed2[sample(nrow(bed2), 20), ]

	circos.genomicLink(bed1, bed2, col = col_fun(bed1[[4]]))

	circos.clear()
}
```

In recently version of **ComplexHeatmap** package, there is a `Legend()` function which customizes
legends with various styles. In following code, legends for the two tracks and links are constructed.
In the end the three legends are packed vertically by `packLegend()`. For more detailed usage of `Legend()`
and `packLegend()`, please refer to their help page.

```{r}
library(ComplexHeatmap)
# discrete
lgd_points = Legend(at = c("label1", "label2"), type = "points", legend_gp = gpar(col = 2:3), 
	title_position = "topleft", title = "Track1")
# discrete
lgd_lines = Legend(at = c("label3", "label4"), type = "lines", legend_gp = gpar(col = 4:5, lwd = 2), 
	title_position = "topleft", title = "Track2")
# continuous
lgd_links = Legend(at = c(-1, -0.5, 0, 0.5, 1), col_fun = col_fun, title_position = "topleft",
	title = "Links")

lgd_list_vertical = packLegend(lgd_points, lgd_lines, lgd_links)
lgd_list_vertical
```

`lgd_points`, `lgd_lines`, `lgd_links` and `lgd_list_vertical` are all `grob` objects (graphical objects), 
which you can think as boxes which contain all graphical elements for legends and they can be added
to the plot by `grid.draw()`.

**circlize** is implemented by the base graphic system while **ComplexHeatmap** is implemented by
**grid** graphic system. However, these two system can be mixed somehow. We can directly add grid graphics
to the base graphics. (Actually they are two independent layers but drawn on a same graphic devide.)

```{r}
circlize_plot()
pushViewport(viewport(x = unit(2, "mm"), y = unit(4, "mm"), width = grobWidth(lgd_list_vertical), 
	height = grobHeight(lgd_list_vertical), just = c("left", "bottom")))
grid.draw(lgd_list_vertical)
upViewport()
```

In above plot, the whole image region corresponds to the circular plot and the legend layer is drawn just on top of it.
If the legends are many and the size for the legends is too big, they may overap to the circle. In this case,
it is better to split the image region into two parts where one part for the circular plot and the other part for legends.

Thanks to **grid** package that it is quite easy to split the image region and thanks to **gridBase** package
that we can easily mix base graphics and grid graphics.

Following code is straightforward to understand. Only one line needs to be noticed: `par(omi = gridOMI(), new = TRUE)`
that `gridOMI()` calculates the outer margins for the base graphics so that the base graphics can be put at the correct
place and `new = TRUE` to ensure the base graphics are added to current graphic device instead of opening a new one.

Here I use `plot.new()` to open a new graphic device. In interactive session, it seems ok if you also use `grid.newpage()`,
but `grid.newpage()` gives error when building a knitr document.


```{r, fig.width = 7, fig.height = 7}
library(gridBase)
plot.new()
circle_size = unit(1, "snpc") - unit(1, "inches")

pushViewport(viewport(x = 0, y = 0.5, width = circle_size, height = circle_size,
	just = c("left", "center")))
par(omi = gridOMI(), new = TRUE)
circlize_plot()
upViewport()

pushViewport(viewport(x = circle_size, y = 0.5, width = grobWidth(lgd_list_vertical), 
	height = grobHeight(lgd_list_vertical), just = c("left", "center")))
grid.draw(lgd_list_vertical)
upViewport()
```

The legends can also be put at the bottom of the circular plot and it is just a matter how users arrange
the grid viewports. In this case, all legends are changed to horizontal style, and three legends are packed horizontally as well.

```{r, fig.width = 7, fig.height = 7}
lgd_points = Legend(at = c("label1", "label2"), type = "points", legend_gp = gpar(col = 2:3), 
	title_position = "topleft", title = "Track1", nrow = 1)

lgd_lines = Legend(at = c("label3", "label4"), type = "lines", legend_gp = gpar(col = 4:5, lwd = 2), 
	title_position = "topleft", title = "Track2", nrow = 1)

lgd_links = Legend(at = c(-1, -0.5, 0, 0.5, 1), col_fun = col_fun, title_position = "topleft",
	title = "Links", direction = "horizontal")

lgd_list_horizontal = packLegend(lgd_points, lgd_lines, lgd_links, direction = "horizontal")

plot.new()
pushViewport(viewport(x = 0.5, y = 1, width = circle_size, height = circle_size,
	just = c("center", "top")))
par(omi = gridOMI(), new = TRUE)
circlize_plot()
upViewport()

pushViewport(viewport(x = 0.5, y = unit(1, "npc") - circle_size, 
	width = grobWidth(lgd_list_horizontal), height = grobHeight(lgd_list_horizontal), 
	just = c("center", "top")))
grid.draw(lgd_list_horizontal)
upViewport()
```

## Session info

```{r}
sessionInfo()
```

<!-- uid=add_legend_to_circlize -->
